{% extends 'dashboard/base.html' %}
{% load player_tags %}
{% load static %}
{% block content %}
<div class="container mt-4">

  <!-- 🔷 Header -->
  <div class="text-center mb-4">
    <img src="{% static 'mfheader.png' %}" alt="Header" class="img-fluid" style="max-height: 120px;">
    <h2>Edit Player</h2>
  </div>

  <!-- ✅ Feedback Messages -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}" role="alert">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- ❗ Validation Errors -->
  {% if form.errors %}
    <div class="alert alert-danger">
      <strong>There were issues with your submission:</strong>
      <ul>
        {% for field in form %}
          {% for error in field.errors %}
            <li><strong>{{ field.label }}:</strong> {{ error }}</li>
          {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
          <li>{{ error }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <!-- 📝 Main Form -->
  <form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input type="hidden" name="save_player" value="1">
    <div class="row">

      <!-- 🧍 Left Column with border -->
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3">
          <div class="mb-3"><label>Player Name *</label>{{ form.player_name }}</div>
          <div class="mb-3"><label>Address *</label>{{ form.player_address }}</div>
          <div class="mb-3">
            <label>Gender</label>
            <select name="gender_id" id="gender_id" class="form-select form-select-sm w-auto">
              {% for g in all_genders %}
                <option value="{{ g.gender_id }}" {% if g.gender_id == player.gender_id %}selected{% endif %}>{{ g.gender_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3" id="gender_specify_block" {% if player.gender_id == 0 or player.gender_id == 1 or player.gender_id == 2 %}style="display:none"{% endif %}>
            <label>Specify Gender</label>
            {{ form.gender_specify }}
          </div>
          <div class="mb-3"><label>Email *</label>{{ form.player_email }}</div>
          <div class="mb-3"><label>Date of Birth</label>{{ form.player_dob }}</div>
          <div class="mb-3"><label>Primary Contact Number *</label>{{ form.player_primary_mobile_number }}</div>
          <div class="mb-3"><label>Primary Contact *</label>{{ form.player_contact_name1 }}</div>
          <div class="mb-3"><label>Secondary Contact Number</label>{{ form.player_secundary_mobile_number }}</div>
          <div class="mb-3"><label>Secondary Contact</label>{{ form.player_contact_name2 }}</div>
        </div>
      </div>
      <!-- 📋 Right Column with border -->
      <div class="col-md-6">
        <div class="border rounded shadow-sm p-3">
          <div class="mb-3"><label>Active</label>{{ form.player_active }}</div>
          <div class="mb-3"><label>Transfer Out</label>{{ form.player_transfer_out }}</div>
          <div class="mb-3"><label>Membership (€)</label>{{ form.player_membership_amount }}</div>
          <div class="mb-3"><label>BI Number</label>{{ form.player_bi_number }}</div>
          <div class="mb-3"><label>Jersey #</label>{{ form.player_jersey }}</div>
          <div class="mb-3">
            <label>Team</label>
            <select name="team" class="form-select form-select-sm w-auto" id="team_dropdown">
              {% for team in all_teams %}
                <option value="{{ team.teams_id }}" {% if team.teams_id == player.player_team_id %}selected{% endif %}>{{ team.teams_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label>Role</label>
            <select name="role" class="form-select form-select-sm w-auto">
              {% for role in all_roles %}
                <option value="{{ role.role_id }}" {% if role.role_id == player.player_role_id %}selected{% endif %}>{{ role.role_name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3"><label>Medical Conditions</label>{{ form.player_medical_conditions }}</div>
          <div class="mb-3"><label>Player is willing to train?</label>{{ form.participation_member_training }}</div>
          <div class="mb-3"><label>Player is willing to play Matches?</label>{{ form.participation_member_play_matches }}</div>
          <div class="mb-3"><label>Other Activities</label>{{ form.participation_member_other_activities }}</div>
          <div class="mb-3"><label>Committee Member</label>{{ form.player_committee_member }}</div>
          <div class="mb-3"><label>Member 1</label>{{ form.player_member_1 }}</div>
          <div class="mb-3"><label>Member 2</label>{{ form.player_member_2 }}</div>
          <div class="mb-3"><label>Member 3</label>{{ form.player_member_3 }}</div>
          <div class="mb-3"><label>Photo Consent</label>{{ form.photo_cons }}</div>
          <div class="mb-3">
            <label>Email Status</label>
            {% if player.sent_membership == 1 %}
              <span class="badge bg-success">Email Sent</span>
            {% else %}
              <span class="badge bg-danger">Email Not Sent</span>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    <!-- 💾 Save Buttons -->
    <div class="text-center mt-4 mb-4">
      <button type="submit" class="btn btn-success">Save</button>
      <a href="{% url 'player_list' %}" class="btn btn-secondary ms-2">Go Back</a>
    </div>

    <!-- 🖼️ Photo Upload -->
    <div class="mb-4">
      <label>Upload Player Image</label><br>
      {{ form.player_photo }}
      {% if player.photo_link %}
        <div class="mt-2">
          <img src="{{ player.photo_link }}" alt="Player Photo" class="img-thumbnail" style="max-width: 200px;">
        </div>
      {% endif %}
    </div>
  </form>

  <!-- 🧠 Dynamic Gender Toggle -->
  <script>
    document.getElementById("gender_id").addEventListener("change", function() {
      const block = document.getElementById("gender_specify_block");
      const val = parseInt(this.value);
      block.style.display = (![0, 1, 2].includes(val)) ? "block" : "none";
    });
  </script>
<!-- 👨‍👩‍👦 Linked Parents Section -->
<hr class="my-5">
<div class="border rounded shadow-sm p-3">
  <h4>Linked Parents</h4>
  <table class="table table-bordered">
    <thead><tr><th>Parent Name</th><th>Email</th><th>Mobile</th><th>Actions</th></tr></thead>
    <tbody>
      {% for link in linked_parent_links %}
        <tr>
          <td>{{ link.parents_id|get_parent_name }}</td>
          <td>{{ link.parents_id|get_parent_email }}</td>
          <td>{{ link.parents_id|get_parent_mobile }}</td>
          <td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="delete_parent" value="1">
              <input type="hidden" name="parent_link_id" value="{{ link.id }}">
              <button class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="4">No parents linked.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="add_parent" value="1">
    <div class="input-group">
      <select name="new_parent_id" class="form-select form-select-sm">
        <option value="">-- Choose Parent --</option>
        {% for p in all_parents %}
          <option value="{{ p.parents_id }}">{{ p.parents_name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-success ms-2">Add Parent</button>
    </div>
  </form>
</div>

<!-- 💳 Payments History -->
<hr class="my-5">
<div class="border rounded shadow-sm p-3">
  <h4>Payment History</h4>
  <table class="table table-bordered">
    <thead>
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Description</th>
        <th>Type</th>
        <th>Amount (€)</th>
      </tr>
    </thead>
    <tbody>
      {% for payment in linked_payments %}
        <tr>
          <td>{{ payment.payments_id }}</td>
          <td>{{ payment.payments_date|date:"d/m/Y" }}</td>
          <td>{{ payment.payments_description }}</td>
          <td>{{ payment.payments_type|get_pt_type }}</td>
          <td>{{ payment.payments_amount|floatformat:2 }}</td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="text-center text-muted">No payments found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <!-- 💰 Total Paid -->
  <div class="text-end mt-2">
    <strong>Total Paid:</strong> €{{ total_amount|floatformat:2 }}
  </div>
</div>

  <!-- 🏅 Other Sports Section -->
<!-- 🏅 Other Sports Section -->
<hr class="my-5">
<div class="border rounded shadow-sm p-3">
  <h4>Other Sports</h4>
  <table class="table table-bordered">
    <thead><tr><th>Sport Name</th><th>Description</th><th>Actions</th></tr></thead>
    <tbody>
      {% for link in linked_sport_links %}
        <tr>
          <td>{{ link.sports_id|get_sport_name }}</td>
          <td>{{ link.sports_id|get_sport_desc }}</td>
          <td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="delete_sport" value="1">
              <input type="hidden" name="sport_link_id" value="{{ link.id }}">
              <button class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="3">No sports linked.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="add_sport" value="1">
    <div class="input-group">
      <select name="new_sport_id" class="form-select form-select-sm">
        <option value="">-- Choose Sport --</option>
        {% for s in all_sports %}
          <option value="{{ s.sports_id }}">{{ s.sports_name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-success ms-2">Add Sport</button>
    </div>
  </form>
</div>

<!-- 🎽 Other Clubs Section -->
<hr class="my-5">
<div class="border rounded shadow-sm p-3">
  <h4>Other Clubs</h4>
  <table class="table table-bordered">
    <thead><tr><th>Club Name</th><th>Description</th><th>Actions</th></tr></thead>
    <tbody>
      {% for link in linked_club_links %}
        <tr>
          <td>{{ link.clubs_id|get_club_name }}</td>
          <td>{{ link.clubs_id|get_club_desc }}</td>
          <td>
            <form method="post">
              {% csrf_token %}
              <input type="hidden" name="delete_club" value="1">
              <input type="hidden" name="club_link_id" value="{{ link.id }}">
              <button class="btn btn-sm btn-danger">Delete</button>
            </form>
          </td>
        </tr>
      {% empty %}
        <tr><td colspan="3">No clubs linked.</td></tr>
      {% endfor %}
    </tbody>
  </table>
  <form method="post" class="mt-3">
    {% csrf_token %}
    <input type="hidden" name="add_club" value="1">
    <div class="input-group">
      <select name="new_club_id" class="form-select form-select-sm">
        <option value="">-- Choose Club --</option>
        {% for c in all_clubs %}
          <option value="{{ c.clubs_id }}">{{ c.clubs_name }}</option>
        {% endfor %}
      </select>
      <button class="btn btn-success ms-2">Add Club</button>
    </div>
  </form>
</div>
  <!-- 🎽 Other Clubs Section -->
  <!-- 👨‍👩‍👦 Linked Sports Section -->

</div>
{% endblock %}